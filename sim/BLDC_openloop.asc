Version 4
SHEET 1 4796 2356
WIRE 464 -496 368 -496
WIRE 560 -496 528 -496
WIRE 752 -480 640 -480
WIRE 560 -464 544 -464
WIRE 496 -448 496 -464
WIRE 496 -448 368 -448
WIRE 544 -400 544 -464
WIRE 544 -400 368 -400
WIRE 752 -336 752 -480
WIRE 464 -320 368 -320
WIRE 560 -320 528 -320
WIRE 720 -304 640 -304
WIRE 864 -304 784 -304
WIRE 944 -304 864 -304
WIRE 560 -288 544 -288
WIRE 1120 -288 1024 -288
WIRE 1568 -288 1376 -288
WIRE 1728 -288 1632 -288
WIRE 496 -272 496 -288
WIRE 496 -272 368 -272
WIRE 944 -272 864 -272
WIRE 1888 -272 1808 -272
WIRE 2112 -272 1952 -272
WIRE 1728 -256 1696 -256
WIRE 544 -224 544 -288
WIRE 544 -224 368 -224
WIRE 1600 -208 1600 -256
WIRE 1600 -208 1552 -208
WIRE 2112 -176 2112 -272
WIRE 864 -160 864 -272
WIRE 1120 -160 864 -160
WIRE 1696 -160 1696 -256
WIRE 1696 -160 1664 -160
WIRE 1888 -160 1808 -160
WIRE 464 -144 368 -144
WIRE 560 -144 528 -144
WIRE 2080 -144 1968 -144
WIRE 752 -128 752 -272
WIRE 752 -128 640 -128
WIRE 1888 -128 1840 -128
WIRE 560 -112 544 -112
WIRE 496 -96 496 -112
WIRE 496 -96 368 -96
WIRE 1840 -80 1840 -128
WIRE 2016 -80 1840 -80
WIRE 544 -48 544 -112
WIRE 544 -48 368 -48
WIRE 1840 -48 1840 -80
WIRE 2016 -32 2016 -80
WIRE -304 48 -416 48
WIRE -144 48 -224 48
WIRE 80 48 -112 48
WIRE -128 96 -128 64
WIRE 80 96 -128 96
WIRE 1840 128 1840 16
WIRE 2112 128 2112 -112
WIRE 2112 128 1840 128
WIRE -304 144 -416 144
WIRE -144 144 -224 144
WIRE 80 144 -112 144
WIRE 656 160 608 160
WIRE 704 160 656 160
WIRE -128 192 -128 160
WIRE 80 192 -128 192
WIRE 496 192 352 192
WIRE 1120 224 928 224
WIRE 1840 224 1840 128
WIRE 1840 224 1360 224
WIRE -304 240 -416 240
WIRE -144 240 -224 240
WIRE 80 240 -112 240
WIRE 464 240 352 240
WIRE 496 240 496 192
WIRE 512 240 496 240
WIRE 608 240 608 160
WIRE 608 240 576 240
WIRE 464 256 464 240
WIRE 512 256 464 256
WIRE 656 256 576 256
WIRE 704 256 656 256
WIRE 2016 256 1904 256
WIRE 512 272 464 272
WIRE 608 272 576 272
WIRE -128 288 -128 256
WIRE 80 288 -128 288
WIRE 464 288 464 272
WIRE 464 288 352 288
WIRE 512 288 496 288
WIRE 1600 288 1360 288
WIRE 1840 288 1840 224
WIRE 1840 288 1664 288
WIRE -256 336 -416 336
WIRE 80 336 -256 336
WIRE 496 336 496 288
WIRE 496 336 352 336
WIRE 608 352 608 272
WIRE 656 352 608 352
WIRE 704 352 656 352
WIRE 1120 352 992 352
WIRE 1904 352 1904 256
WIRE 1904 352 1360 352
WIRE 1984 368 1936 368
WIRE 2112 368 1984 368
WIRE 448 416 352 416
WIRE 560 416 560 304
WIRE 928 416 928 224
WIRE 928 416 560 416
WIRE 1936 416 1936 368
WIRE 1936 416 1360 416
WIRE 448 464 352 464
WIRE 528 480 528 304
WIRE 816 480 528 480
WIRE 992 480 992 352
WIRE 992 480 880 480
WIRE 1472 480 1360 480
WIRE 448 512 352 512
WIRE 672 832 624 832
WIRE 816 832 736 832
WIRE 896 832 816 832
WIRE 1024 832 960 832
WIRE 1232 864 1232 848
WIRE 1888 864 1744 864
WIRE 816 880 816 832
WIRE 624 944 624 832
WIRE 624 944 592 944
WIRE 688 944 624 944
WIRE 1056 944 944 944
WIRE 1184 944 1136 944
WIRE 1888 960 1744 960
WIRE 2160 960 2016 960
WIRE 2304 960 2160 960
WIRE 2160 976 2160 960
WIRE 2192 976 2160 976
WIRE 1232 992 1232 960
WIRE 1232 992 1184 992
WIRE 1456 992 1232 992
WIRE 2160 992 2160 976
WIRE 560 1008 448 1008
WIRE 640 1024 640 1008
WIRE 688 1024 640 1024
WIRE 1024 1024 1024 832
WIRE 1024 1024 944 1024
WIRE 1184 1024 1184 992
WIRE 1184 1024 1024 1024
WIRE 1232 1024 1232 992
WIRE 1888 1056 1744 1056
WIRE 2304 1072 2160 1072
WIRE 2368 1072 2304 1072
WIRE 2304 1088 2304 1072
WIRE 688 1104 640 1104
WIRE 1056 1104 944 1104
WIRE 1184 1104 1136 1104
WIRE 560 1120 448 1120
WIRE 640 1120 640 1104
WIRE 1232 1136 1232 1120
WIRE -352 1168 -416 1168
WIRE -336 1168 -352 1168
WIRE -80 1168 -144 1168
WIRE -64 1168 -80 1168
WIRE 816 1184 816 1168
WIRE -592 1200 -688 1200
WIRE -416 1200 -416 1168
WIRE -144 1200 -144 1168
WIRE -352 1232 -352 1168
WIRE -336 1232 -352 1232
WIRE -80 1232 -80 1168
WIRE -32 1232 -80 1232
WIRE -592 1296 -704 1296
WIRE 672 1296 624 1296
WIRE 816 1296 736 1296
WIRE 896 1296 816 1296
WIRE 1024 1296 960 1296
WIRE 1232 1328 1232 1312
WIRE 816 1344 816 1296
WIRE 2000 1376 2000 1360
WIRE 2304 1376 2304 1360
WIRE 2608 1376 2608 1360
WIRE -112 1408 -176 1408
WIRE 624 1408 624 1296
WIRE 624 1408 592 1408
WIRE 688 1408 624 1408
WIRE 1056 1408 944 1408
WIRE 1184 1408 1136 1408
WIRE 64 1424 -32 1424
WIRE 256 1424 64 1424
WIRE -112 1440 -240 1440
WIRE 1232 1456 1232 1424
WIRE 1232 1456 1184 1456
WIRE 1456 1456 1232 1456
WIRE 560 1472 448 1472
WIRE 640 1488 640 1472
WIRE 688 1488 640 1488
WIRE 1024 1488 1024 1296
WIRE 1024 1488 944 1488
WIRE 1184 1488 1184 1456
WIRE 1184 1488 1024 1488
WIRE 1232 1488 1232 1456
WIRE 1856 1488 1824 1488
WIRE 2000 1488 2000 1440
WIRE 2000 1488 1856 1488
WIRE 2160 1488 2112 1488
WIRE 2304 1488 2304 1440
WIRE 2304 1488 2160 1488
WIRE 2464 1488 2416 1488
WIRE 2608 1488 2608 1440
WIRE 2608 1488 2464 1488
WIRE 2000 1504 2000 1488
WIRE 2304 1504 2304 1488
WIRE 2608 1504 2608 1488
WIRE -112 1536 -176 1536
WIRE 64 1552 -32 1552
WIRE 256 1552 64 1552
WIRE -112 1568 -240 1568
WIRE 688 1568 640 1568
WIRE 1056 1568 944 1568
WIRE 1184 1568 1136 1568
WIRE 560 1584 448 1584
WIRE 640 1584 640 1568
WIRE 1232 1600 1232 1584
WIRE 1824 1632 1824 1488
WIRE 2112 1632 2112 1488
WIRE 2416 1632 2416 1488
WIRE 816 1648 816 1632
WIRE -112 1664 -176 1664
WIRE 64 1680 -32 1680
WIRE 256 1680 64 1680
WIRE -112 1696 -240 1696
WIRE 672 1760 624 1760
WIRE 816 1760 736 1760
WIRE 896 1760 816 1760
WIRE 1024 1760 960 1760
WIRE -112 1792 -176 1792
WIRE 1232 1792 1232 1776
WIRE 64 1808 -32 1808
WIRE 256 1808 64 1808
WIRE 816 1808 816 1760
WIRE -112 1824 -240 1824
WIRE 2128 1856 2096 1856
WIRE 624 1872 624 1760
WIRE 624 1872 592 1872
WIRE 688 1872 624 1872
WIRE 1056 1872 944 1872
WIRE 1184 1872 1136 1872
WIRE 2224 1872 2192 1872
WIRE 2128 1888 2096 1888
WIRE -112 1920 -176 1920
WIRE 1232 1920 1232 1888
WIRE 1232 1920 1184 1920
WIRE 1456 1920 1232 1920
WIRE 64 1936 -32 1936
WIRE 256 1936 64 1936
WIRE 560 1936 448 1936
WIRE -112 1952 -240 1952
WIRE 640 1952 640 1936
WIRE 688 1952 640 1952
WIRE 1024 1952 1024 1760
WIRE 1024 1952 944 1952
WIRE 1184 1952 1184 1920
WIRE 1184 1952 1024 1952
WIRE 1232 1952 1232 1920
WIRE 2128 1952 2096 1952
WIRE 2224 1968 2192 1968
WIRE 2128 1984 2096 1984
WIRE 688 2032 640 2032
WIRE 1056 2032 944 2032
WIRE 1184 2032 1136 2032
WIRE -112 2048 -176 2048
WIRE 560 2048 448 2048
WIRE 640 2048 640 2032
WIRE 2128 2048 2096 2048
WIRE 64 2064 -32 2064
WIRE 256 2064 64 2064
WIRE 1232 2064 1232 2048
WIRE 2224 2064 2192 2064
WIRE -112 2080 -240 2080
WIRE 2128 2080 2096 2080
WIRE 816 2112 816 2096
FLAG -416 48 FASE_A
IOPIN -416 48 In
FLAG -416 144 FASE_B
IOPIN -416 144 In
FLAG -416 240 FASE_C
IOPIN -416 240 In
FLAG -256 416 0
FLAG -416 336 Neutral
IOPIN -416 336 In
FLAG 784 160 0
FLAG 784 256 0
FLAG 784 352 0
FLAG 352 512 HALL_C
IOPIN 352 512 Out
FLAG 352 464 HALL_B
IOPIN 352 464 Out
FLAG 352 416 HALL_A
IOPIN 352 416 Out
FLAG 80 48 BEMFA
IOPIN 80 48 In
FLAG 368 -496 BEMFA
IOPIN 368 -496 In
FLAG 368 -448 Neutral
IOPIN 368 -448 In
FLAG 368 -400 I_A
IOPIN 368 -400 In
FLAG 80 96 I_A
IOPIN 80 96 Out
FLAG 80 192 I_B
IOPIN 80 192 Out
FLAG 80 288 I_C
IOPIN 80 288 Out
FLAG 80 144 BEMFB
IOPIN 80 144 In
FLAG 80 240 BEMFC
IOPIN 80 240 In
FLAG 368 -320 BEMFB
IOPIN 368 -320 In
FLAG 368 -272 Neutral
IOPIN 368 -272 In
FLAG 368 -224 I_B
IOPIN 368 -224 In
FLAG 368 -144 BEMFC
IOPIN 368 -144 In
FLAG 368 -96 Neutral
IOPIN 368 -96 In
FLAG 368 -48 I_C
IOPIN 368 -48 In
FLAG 864 -304 Pe_inst
FLAG 864 -272 wang
FLAG 1120 -288 Tmotor
IOPIN 1120 -288 Out
FLAG 1120 -160 wang
IOPIN 1120 -160 In
FLAG 80 336 Neutral
IOPIN 80 336 In
FLAG 352 192 BEMFA
IOPIN 352 192 Out
FLAG 352 336 Neutral
IOPIN 352 336 Out
FLAG 352 240 BEMFB
IOPIN 352 240 Out
FLAG 352 288 BEMFC
IOPIN 352 288 Out
FLAG 656 160 HALL_A
FLAG 656 256 HALL_B
FLAG 656 352 HALL_C
FLAG 1120 224 wang
IOPIN 1120 224 In
FLAG 1120 352 theta_t
IOPIN 1120 352 In
FLAG 1376 -288 Tmotor
IOPIN 1376 -288 In
FLAG 1552 -208 Tload
IOPIN 1552 -208 In
FLAG 1360 224 wang
IOPIN 1360 224 Out
FLAG 2016 -32 theta_t
FLAG 1360 480 Tmotor
IOPIN 1360 480 Out
FLAG 1360 352 theta_t
IOPIN 1360 352 Out
FLAG 1360 288 rpm
IOPIN 1360 288 Out
FLAG 1360 416 theta
IOPIN 1360 416 Out
FLAG 2016 256 theta_t
FLAG 2112 448 0
FLAG 1984 448 0
FLAG -688 1200 duty
IOPIN -688 1200 In
FLAG -512 1200 0
FLAG -144 1280 0
FLAG -416 1280 0
FLAG -336 1168 triangular
FLAG -704 1296 Vdc
IOPIN -704 1296 In
FLAG -512 1296 0
FLAG -64 1168 PWM
FLAG -352 960 0
FLAG -352 880 Vdc
FLAG -576 960 0
FLAG -576 880 duty
FLAG -256 1232 0
FLAG 48 1232 0
FLAG -240 1440 HA
IOPIN -240 1440 In
FLAG -496 1552 0
FLAG -496 1472 HA
FLAG -176 1408 PWM
FLAG 256 1424 HAI
IOPIN 256 1424 Out
FLAG 64 1504 0
FLAG -240 1568 LA
IOPIN -240 1568 In
FLAG -176 1536 Vdc
FLAG 256 1552 LAI
IOPIN 256 1552 Out
FLAG 64 1632 0
FLAG -240 1696 HB
IOPIN -240 1696 In
FLAG -176 1664 PWM
FLAG 256 1680 HBI
IOPIN 256 1680 Out
FLAG 64 1760 0
FLAG -240 1824 LB
IOPIN -240 1824 In
FLAG -176 1792 Vdc
FLAG 256 1808 LBI
IOPIN 256 1808 Out
FLAG 64 1888 0
FLAG -240 1952 HC
IOPIN -240 1952 In
FLAG -176 1920 PWM
FLAG 256 1936 HCI
IOPIN 256 1936 Out
FLAG 64 2016 0
FLAG -240 2080 LC
IOPIN -240 2080 In
FLAG -176 2048 Vdc
FLAG 256 2064 LCI
IOPIN 256 2064 Out
FLAG 64 2144 0
FLAG -400 1552 0
FLAG -400 1472 LA
FLAG -496 1808 0
FLAG -496 1728 HB
FLAG -400 1808 0
FLAG -400 1728 LB
FLAG -480 2064 0
FLAG -480 1984 HC
FLAG -384 2064 0
FLAG -384 1984 LC
FLAG 816 1184 0
FLAG 592 944 VCC
FLAG 1232 848 VCC
FLAG 1456 992 FASE_A
IOPIN 1456 992 Out
FLAG 1232 1216 0
FLAG 448 1008 HAI
IOPIN 448 1008 In
FLAG 448 1120 LAI
IOPIN 448 1120 In
FLAG 448 1472 HBI
IOPIN 448 1472 In
FLAG 448 1584 LBI
IOPIN 448 1584 In
FLAG 448 1936 HCI
IOPIN 448 1936 In
FLAG 448 2048 LCI
IOPIN 448 2048 In
FLAG 816 1648 0
FLAG 592 1408 VCC
FLAG 1232 1312 VCC
FLAG 1456 1456 FASE_B
IOPIN 1456 1456 Out
FLAG 1232 1680 0
FLAG 816 2112 0
FLAG 592 1872 VCC
FLAG 1232 1776 VCC
FLAG 1456 1920 FASE_C
IOPIN 1456 1920 Out
FLAG 1232 2144 0
FLAG -112 960 0
FLAG -112 880 VCC
FLAG 112 960 0
FLAG 112 880 Tload
FLAG 1744 864 FASE_A
IOPIN 1744 864 In
FLAG 1744 960 FASE_B
IOPIN 1744 960 In
FLAG 1744 1056 FASE_C
IOPIN 1744 1056 In
FLAG 2016 880 FASE_A
FLAG 2160 880 FASE_B
FLAG 2304 880 FASE_C
FLAG 2192 976 N_virtual
FLAG 1856 1568 0
FLAG 1856 1408 FASE_A
FLAG 2000 1568 0
FLAG 2000 1360 N_virtual_div
FLAG 2160 1152 0
FLAG 2304 1152 0
FLAG 2368 1072 N_virtual_div
FLAG 2160 1568 0
FLAG 2160 1408 FASE_B
FLAG 2304 1568 0
FLAG 2304 1360 N_virtual_div
FLAG 2464 1568 0
FLAG 2464 1408 FASE_C
FLAG 2608 1568 0
FLAG 2608 1360 N_virtual_div
FLAG 1824 1632 BEMF_A_rec
FLAG 2112 1632 BEMF_B_rec
FLAG 2416 1632 BEMF_C_rec
FLAG 2096 1856 BEMF_A_rec
FLAG 2096 1888 N_virtual_div
FLAG 2224 1872 sensorlessA
FLAG 2096 1952 BEMF_B_rec
FLAG 2096 1984 N_virtual_div
FLAG 2224 1968 sensorlessB
FLAG 2096 2048 BEMF_C_rec
FLAG 2096 2080 N_virtual_div
FLAG 2224 2064 sensorlessC
SYMBOL BEMF 512 240 R0
SYMATTR SpiceLine KT=15e-3
SYMATTR InstName U1
SYMBOL ind -320 64 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 5 56 VBottom 2
SYMATTR InstName L1
SYMATTR Value {Lm}
SYMATTR SpiceLine Rser={Rm}
SYMBOL ind -320 160 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 5 56 VBottom 2
SYMATTR InstName L2
SYMATTR Value {Lm}
SYMATTR SpiceLine Rser={Rm}
SYMBOL ind -320 256 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 5 56 VBottom 2
SYMATTR InstName L3
SYMATTR Value {Lm}
SYMATTR SpiceLine Rser={Rm}
SYMBOL res -240 432 R180
WINDOW 0 36 76 Left 2
WINDOW 3 36 40 Left 2
SYMATTR InstName R1
SYMATTR Value 1G
SYMBOL res 688 176 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 0 56 VBottom 2
SYMATTR InstName R2
SYMATTR Value 1G
SYMBOL res 688 272 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 0 56 VBottom 2
SYMATTR InstName R3
SYMATTR Value 1G
SYMBOL res 688 368 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 0 56 VBottom 2
SYMATTR InstName R4
SYMATTR Value 1G
SYMBOL Control\\isense -128 48 R0
WINDOW 0 -2 -38 Invisible 2
SYMATTR InstName U2
SYMBOL Control\\isense -128 144 R0
WINDOW 0 -2 -38 Invisible 2
SYMATTR InstName U3
SYMBOL Control\\isense -128 240 R0
WINDOW 0 -2 -38 Invisible 2
SYMATTR InstName U4
SYMBOL Control\\sub2 496 -496 R0
WINDOW 0 1 -38 Invisible 2
SYMATTR InstName U5
SYMBOL Control\\mul 592 -480 R0
WINDOW 0 0 -38 Invisible 2
SYMATTR InstName U8
SYMBOL Control\\sub2 496 -320 R0
WINDOW 0 1 -38 Invisible 2
SYMATTR InstName U6
SYMBOL Control\\mul 592 -304 R0
WINDOW 0 0 -38 Invisible 2
SYMATTR InstName U7
SYMBOL Control\\sub2 496 -144 R0
WINDOW 0 1 -38 Invisible 2
SYMATTR InstName U9
SYMBOL Control\\mul 592 -128 R0
WINDOW 0 0 -38 Invisible 2
SYMATTR InstName U10
SYMBOL Control\\adder3 752 -304 R0
WINDOW 0 0 -65 Invisible 2
SYMATTR InstName U11
SYMBOL Control\\div 976 -288 R0
WINDOW 0 0 -38 Invisible 2
SYMATTR InstName U12
SYMBOL Control\\sub2 1600 -288 R0
WINDOW 0 1 -38 Invisible 2
SYMATTR InstName U13
SYMBOL Control\\div 1760 -272 R0
WINDOW 0 0 -38 Invisible 2
SYMATTR InstName U14
SYMATTR Value eps=0
SYMBOL Control\\constant 1632 -160 R0
WINDOW 0 -2 -38 Invisible 2
SYMATTR InstName U15
SYMATTR Value K={J}
SYMBOL Control\\integ 1920 -272 R0
WINDOW 0 -2 -38 Invisible 2
SYMATTR InstName U16
SYMBOL Control\\sub2 2112 -144 R90
WINDOW 0 1 -38 Invisible 2
SYMATTR InstName U17
SYMBOL Control\\constant 1776 -160 R0
WINDOW 0 -2 -38 Invisible 2
SYMATTR InstName U18
SYMATTR Value K={B/J}
SYMBOL Control\\mul 1920 -144 R0
WINDOW 0 0 -38 Invisible 2
SYMATTR InstName U19
SYMBOL Control\\integ 1840 -16 R270
WINDOW 0 -2 -38 Invisible 2
SYMATTR InstName U20
SYMBOL Control\\gain 1632 288 R180
WINDOW 0 -2 -38 Invisible 2
SYMATTR InstName U21
SYMATTR Value A={60 / (2*pi)}
SYMBOL bv 2112 352 R0
WINDOW 3 24 96 Invisible 2
SYMATTR Value V={ (V(theta_t) / (2*pi) - floor(V(theta_t) / (2*pi)) ) * 2*pi }
SYMATTR InstName B1
SYMBOL res 1968 352 R0
SYMATTR InstName R5
SYMATTR Value 1G
SYMBOL res -496 1184 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R7
SYMATTR Value 1G
SYMBOL bv -144 1184 R0
WINDOW 3 24 96 Invisible 2
SYMATTR Value V={V(Vdc) * if(V(triangular) < V(duty), 1, 0)}
SYMATTR InstName B2
SYMBOL voltage -416 1184 R0
WINDOW 3 -18 146 Invisible 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR Value PULSE(0 1 0 {1/(2*{f_pwm})} {1/(2*{f_pwm})} 0 {1/{f_pwm}})
SYMATTR InstName V3
SYMBOL res -496 1280 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R8
SYMATTR Value 1G
SYMBOL voltage -352 864 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V5
SYMATTR Value 3.3
SYMBOL voltage -576 864 R0
SYMATTR InstName V6
SYMATTR Value 0.6
SYMBOL res -240 1216 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R9
SYMATTR Value 1G
SYMBOL res 64 1216 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R10
SYMATTR Value 1G
SYMBOL voltage -496 1456 R0
WINDOW 3 24 96 Invisible 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR Value PULSE(0 1 0 1u 1u {2*{state_period}} {6*{state_period}})
SYMATTR InstName V7
SYMBOL Control\\mul -80 1424 R0
SYMATTR InstName U22
SYMBOL res 48 1408 R0
SYMATTR InstName R11
SYMATTR Value 1G
SYMBOL Control\\mul -80 1552 R0
SYMATTR InstName U23
SYMBOL res 48 1536 R0
SYMATTR InstName R12
SYMATTR Value 1G
SYMBOL Control\\mul -80 1680 R0
SYMATTR InstName U24
SYMBOL res 48 1664 R0
SYMATTR InstName R13
SYMATTR Value 1G
SYMBOL Control\\mul -80 1808 R0
SYMATTR InstName U25
SYMBOL res 48 1792 R0
SYMATTR InstName R14
SYMATTR Value 1G
SYMBOL Control\\mul -80 1936 R0
SYMATTR InstName U26
SYMBOL res 48 1920 R0
SYMATTR InstName R15
SYMATTR Value 1G
SYMBOL Control\\mul -80 2064 R0
SYMATTR InstName U27
SYMBOL res 48 2048 R0
SYMATTR InstName R16
SYMATTR Value 1G
SYMBOL voltage -400 1456 R0
WINDOW 3 24 96 Invisible 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR Value PULSE(0 1 {3*{state_period}} 1u 1u {2*{state_period}} {6*{state_period}})
SYMATTR InstName V8
SYMBOL voltage -496 1712 R0
WINDOW 3 24 96 Invisible 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR Value PULSE(0 1 {2*{state_period}} 1u 1u {2*{state_period}} {6*{state_period}})
SYMATTR InstName V9
SYMBOL voltage -400 1712 R0
WINDOW 3 24 96 Invisible 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR Value PULSE(0 1 {5*{state_period}} 1u 1u {2*{state_period}} {6*{state_period}})
SYMATTR InstName V10
SYMBOL voltage -480 1968 R0
WINDOW 3 24 96 Invisible 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR Value PULSE(0 1 {4*{state_period}} 1u 1u {2*{state_period}} {6*{state_period}})
SYMATTR InstName V11
SYMBOL voltage -384 1968 R0
WINDOW 3 24 96 Invisible 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR Value PULSE(0 1 {1*{state_period}} 1u 1u {2*{state_period}} {6*{state_period}})
SYMATTR InstName V12
SYMBOL PowerProducts\\LTC4446 816 1024 R0
SYMATTR InstName U28
SYMBOL cap 960 816 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C1
SYMATTR Value {C_boot}
SYMBOL res 1152 928 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R6
SYMATTR Value {Rg}
SYMBOL res 1152 1088 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R17
SYMATTR Value {Rg}
SYMBOL schottky 672 848 R270
WINDOW 0 32 32 VTop 2
WINDOW 3 0 32 VBottom 2
SYMATTR InstName D1
SYMATTR Value 1N5818
SYMATTR Description Diode
SYMATTR Type diode
SYMBOL nmos 1184 1024 R0
SYMATTR InstName M1
SYMATTR Value IRFHM830D
SYMBOL nmos 1184 864 R0
SYMATTR InstName M2
SYMATTR Value IRFHM830D
SYMBOL res 1216 1120 R0
SYMATTR InstName R18
SYMATTR Value {Rsense}
SYMBOL res 656 992 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R19
SYMATTR Value {R_in}
SYMBOL res 656 1104 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R20
SYMATTR Value {R_in}
SYMBOL PowerProducts\\LTC4446 816 1488 R0
SYMATTR InstName U29
SYMBOL cap 960 1280 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C2
SYMATTR Value {C_boot}
SYMBOL res 1152 1392 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R21
SYMATTR Value {Rg}
SYMBOL res 1152 1552 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R22
SYMATTR Value {Rg}
SYMBOL schottky 672 1312 R270
WINDOW 0 32 32 VTop 2
WINDOW 3 0 32 VBottom 2
SYMATTR InstName D2
SYMATTR Value 1N5818
SYMATTR Description Diode
SYMATTR Type diode
SYMBOL nmos 1184 1488 R0
SYMATTR InstName M3
SYMATTR Value IRFHM830D
SYMBOL nmos 1184 1328 R0
SYMATTR InstName M4
SYMATTR Value IRFHM830D
SYMBOL res 1216 1584 R0
SYMATTR InstName R23
SYMATTR Value {Rsense}
SYMBOL res 656 1456 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R24
SYMATTR Value {R_in}
SYMBOL res 656 1568 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R25
SYMATTR Value {R_in}
SYMBOL PowerProducts\\LTC4446 816 1952 R0
SYMATTR InstName U30
SYMBOL cap 960 1744 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C3
SYMATTR Value {C_boot}
SYMBOL res 1152 1856 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R26
SYMATTR Value {Rg}
SYMBOL res 1152 2016 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R27
SYMATTR Value {Rg}
SYMBOL schottky 672 1776 R270
WINDOW 0 32 32 VTop 2
WINDOW 3 0 32 VBottom 2
SYMATTR InstName D3
SYMATTR Value 1N5818
SYMATTR Description Diode
SYMATTR Type diode
SYMBOL nmos 1184 1952 R0
SYMATTR InstName M5
SYMATTR Value IRFHM830D
SYMBOL nmos 1184 1792 R0
SYMATTR InstName M6
SYMATTR Value IRFHM830D
SYMBOL res 1216 2048 R0
SYMATTR InstName R28
SYMATTR Value {Rsense}
SYMBOL res 656 1920 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R29
SYMATTR Value {R_in}
SYMBOL res 656 2032 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R30
SYMATTR Value {R_in}
SYMBOL voltage -112 864 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V1
SYMATTR Value 10
SYMBOL voltage 112 864 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V2
SYMATTR Value 1e-2
SYMBOL Control\\gain 848 480 R180
WINDOW 0 5 -20 Bottom 2
SYMATTR InstName U31
SYMATTR Value A=6
SYMBOL res 2000 864 R0
SYMATTR InstName R31
SYMATTR Value {Rstar}
SYMBOL res 2144 864 R0
SYMATTR InstName R32
SYMATTR Value {Rstar}
SYMBOL res 2288 864 R0
SYMATTR InstName R33
SYMATTR Value {Rstar}
SYMBOL res 1840 1392 R0
SYMATTR InstName R34
SYMATTR Value {RdivH}
SYMBOL res 1840 1472 R0
SYMATTR InstName R35
SYMATTR Value {RdivL}
SYMBOL cap 1984 1504 R0
SYMATTR InstName C4
SYMATTR Value {Cgnd}
SYMBOL cap 1984 1376 R0
SYMATTR InstName C5
SYMATTR Value {Cbypass}
SYMBOL res 2144 976 R0
SYMATTR InstName R36
SYMATTR Value {RdivH}
SYMBOL res 2144 1056 R0
SYMATTR InstName R37
SYMATTR Value {RdivL}
SYMBOL cap 2288 1088 R0
SYMATTR InstName C6
SYMATTR Value {Cgnd}
SYMBOL res 2144 1392 R0
SYMATTR InstName R38
SYMATTR Value {RdivH}
SYMBOL res 2144 1472 R0
SYMATTR InstName R39
SYMATTR Value {RdivL}
SYMBOL cap 2288 1504 R0
SYMATTR InstName C7
SYMATTR Value {Cgnd}
SYMBOL cap 2288 1376 R0
SYMATTR InstName C8
SYMATTR Value {Cbypass}
SYMBOL res 2448 1392 R0
SYMATTR InstName R40
SYMATTR Value {RdivH}
SYMBOL res 2448 1472 R0
SYMATTR InstName R41
SYMATTR Value {RdivL}
SYMBOL cap 2592 1504 R0
SYMATTR InstName C9
SYMATTR Value {Cgnd}
SYMBOL cap 2592 1376 R0
SYMATTR InstName C10
SYMATTR Value {Cbypass}
SYMBOL Control\\comp 2160 1872 R0
SYMATTR InstName U33
SYMBOL Control\\comp 2160 1968 R0
SYMATTR InstName U32
SYMBOL Control\\comp 2160 2064 R0
SYMATTR InstName U34
TEXT -376 -24 Left 2 !.param Lm=30u Rm=0.08
TEXT 808 -552 Left 2 ;Conversio de domini \nelectric a mecanic
TEXT 776 -432 Left 2 ;--> Tmotor = Pe_inst / w
TEXT 840 -480 Left 2 ;Pe_inst = Pmec
TEXT -120 -72 Left 2 ;Domini elèctric
TEXT 824 144 Left 2 ;Conversio de domini \nmecanic a electric
TEXT 1528 -88 Left 2 !.param J=1e-6 B=2e-3
TEXT 1456 -448 Left 2 ;Domini mecànic
TEXT 2080 216 Left 2 ;Mesures
TEXT 1488 -384 Left 2 ;2ona llei Newton --> \n--> w = 1/J int(Tmotor-Tload, dt) - B/J int(w,dt)
TEXT -552 -552 Left 4 ;MODEL FUNCIONAL MOTOR
TEXT 520 728 Left 4 ;DRIVERS DE POTENCIA
TEXT 1816 720 Left 4 ;EXTRACCIO BEMF
TEXT -616 1088 Left 4 ;MODUL GENERACIO SENYALS EXCITACIO
TEXT -288 776 Left 2 !.tran 0 1 0
TEXT -440 1136 Left 2 !.param f_pwm=20K
TEXT -616 1392 Left 2 !.param state_period=1.2m
TEXT 528 776 Left 2 !.param R_in=33 Rg=33 C_boot=1000n Rsense=1e-2
TEXT 1824 760 Left 2 !.param Rstar=1K RdivH=33K RdivL=12K Cbypass=33n Cgnd=1p
TEXT 2376 592 Left 2 ;Amb valors de Rstar de l'ordre de K ens assegurem que,\ndonat que el valor de les resistències internes del motor \nes tan baix, que tot el corrent vagi al motor i les pèrdues siguin negligibles
TEXT 2768 1712 VLeft 2 ;Amb aquesta capacitat de bypass ens assegurem de \nretallar la freqüència del PWM mantenint la del rotor
TEXT 496 2184 Left 2 ;Configuració estàndard de mig pont, com a EPC
TEXT -648 2176 Left 2 ;Només tenim PWM a les entrades HI, les LOW les controlem amb GPIO
TEXT 344 -600 Left 2 ;com bé es normal, la BEMF del motor afecta al parell de forces resultant
TEXT 1768 1168 VRight 2 ;necessari divisor de tensió pq aquestes tensions son molt altes
TEXT 1800 2192 Left 2 ;detecció de pas per zero amb els comparadors, les sortides dels quals aniran a GPIOs
TEXT -528 512 Left 2 ;emulació de la resposta del motor en forma d'inducció emag
RECTANGLE Normal 1072 -16 432 -576 2
RECTANGLE Normal 64 480 -400 -96 1
RECTANGLE Normal 1072 544 432 112 2
RECTANGLE Normal 2256 528 1408 -480 1
RECTANGLE Normal 2192 160 1440 -416 2
RECTANGLE Normal 1440 496 2192 192 2
RECTANGLE Normal 2336 608 -624 -640
RECTANGLE Normal 1408 2208 480 688
RECTANGLE Normal 2816 2208 1792 688
RECTANGLE Normal 224 2192 -656 1040
